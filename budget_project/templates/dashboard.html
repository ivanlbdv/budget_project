{% extends 'base.html' %}
{% load extra_filters %}
{% load l10n %}

{% block title %}Главная{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
    <div class="alert alert-warning text-center">
        Пожалуйста, <a href="{% url 'login' %}">войдите</a> в систему, чтобы увидеть данные.
    </div>
{% else %}

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Доходы</h5>
                <p class="card-text fs-4">{{ total_income|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">Расходы</h5>
                <p class="card-text fs-4">{{ total_expense|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Баланс</h5>
                <p class="card-text fs-4">{{ total_income|subtract:total_expense|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
</div>

<!-- Форма поиска и фильтров -->
<form method="get" class="mb-4">
    <div class="row g-3">
        <!-- Поиск по описанию -->
        <div class="col-md-3">
            <label for="search" class="form-label">Поиск по описанию</label>
            <input type="text"
                   class="form-control"
                   id="search"
                   name="q"
                   value="{{ search_query }}"
                   placeholder="Введите текст...">
        </div>

        <!-- Категория -->
        <div class="col-md-3">
            <label for="category" class="form-label">Категория</label>
            <select class="form-select" id="category" name="category">
                <option value="">Все категории</option>
                {% for category in categories %}
                <option value="{{ category.id }}"
                        {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Дата начала -->
        <div class="col-md-3">
            <label for="start_date" class="form-label">Начало периода</label>
            <input type="date" 
                   class="form-control"
                   id="start_date"
                   name="start_date"
                   value="{% if start_date %}{{ start_date }}{% endif %}">
        </div>

        <!-- Дата окончания -->
        <div class="col-md-3">
            <label for="end_date" class="form-label">Конец периода</label>
            <input type="date"
                   class="form-control"
                   id="end_date"
                   name="end_date"
                   value="{% if end_date %}{{ end_date }}{% endif %}">
        </div>

        <!-- Кнопки -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Найти</button>
        </div>
        <div class="col-md-2">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary w-100">Очистить</a>
        </div>
        <div class="col-md-2">
            <a href="{% url 'export_csv' %}?start_date={{ start_date }}&end_date={{ end_date }}&q={{ search_query }}&category={{ selected_category }}"
               class="btn btn-outline-primary w-100">Экспорт в CSV</a>
        </div>
    </div>
</form>

<!-- Таблица операций -->
<div class="card">
    <div class="card-header">
        <h5>Последние операции</h5>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Тип</th>
                    <th>Сумма</th>
                    <th>Категория</th>
                    <th>Описание</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr>
                    <td>{{ transaction.date }}</td>
                    <td>
                        {% if transaction.transaction_type == 'income' %}
                            <span class="text-success">Доход</span>
                        {% else %}
                            <span class="text-danger">Расход</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ transaction.amount }} ₽
                    </td>
                    <td>{{ transaction.category.name|default:"—" }}</td>
                    <td>{{ transaction.description|default:"—" }}</td>
                    <td>
                      <!-- Кнопка редактирования -->
                      <a href="{% url 'edit_transaction' transaction.id %}"
                        class="btn btn-sm btn-outline-primary">
                        Редактировать
                      </a>
                    </td>
                    <td>
                      <!-- Кнопка удаления с подтверждением -->
                      <a href="{% url 'delete_transaction' transaction.id %}"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Вы уверены, что хотите удалить эту операцию?')">
                        Удалить
                      </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">Нет операций за выбранный период</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ПЕРЕДАЧА ДАННЫХ ДЛЯ ГРАФИКОВ -->
{{ labels_expense|json_script:"labelsExpense" }}
{{ data_expense|json_script:"dataExpense" }}
{{ labels_income|json_script:"labelsIncome" }}
{{ data_income|json_script:"dataIncome" }}

<!-- ПЕРЕДАЧА ДАННЫХ ДЛЯ КРУГОВОЙ ДИАГРАММЫ -->
{{ pie_labels|json_script:"pieLabels" }}
{{ pie_data|json_script:"pieData" }}

<!-- Графики -->
<div class="row mt-4">
    <!-- График расходов -->
    <div class="col-md-6">
        <h6 style="text-align: center; width: 100%;">Расходы по месяцам</h6>
        <canvas id="expenseChart" width="400" height="200"></canvas>
    </div>

    <!-- График доходов -->
    <div class="col-md-6">
        <h6 style="text-align: center; width: 100%;">Доходы по месяцам</h6>
        <canvas id="incomeChart" width="400" height="200"></canvas>
    </div>
</div>

<!-- Круговая диаграмма (распределение расходов по категориям) -->
<div class="container mt-5">
  <h4 class="text-center">Распределение расходов по категориям</h4>
  <div style="
    width: 350px;
    height: 350px;
    margin: 20px auto;
    display: flex;
    justify-content: center;
    align-items: center;
  ">
    <canvas id="pieChart"></canvas>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // График расходов
    const ctxExpense = document.getElementById('expenseChart').getContext('2d');
    const expenseChart = new Chart(ctxExpense, {
      type: 'bar',
      data: {
        labels: JSON.parse(document.getElementById('labelsExpense').textContent),
        datasets: [{
          label: 'Расходы (₽)',
          data: JSON.parse(document.getElementById('dataExpense').textContent),
          backgroundColor: 'rgba(220, 53, 69, 0.6)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₽ ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₽ ' + value.toLocaleString();
              }
            },
            title: { display: true, text: 'Сумма (₽)' }
          },
          x: { 
            title: { display: true, text: 'Месяц' },
          }
        }
      }
    });

    // График доходов
    const ctxIncome = document.getElementById('incomeChart').getContext('2d');
    const incomeChart = new Chart(ctxIncome, {
      type: 'bar',
      data: {
        labels: JSON.parse(document.getElementById('labelsIncome').textContent),
        datasets: [{
          label: 'Доходы (₽)',
          data: JSON.parse(document.getElementById('dataIncome').textContent),
          backgroundColor: 'rgba(40, 167, 69, 0.6)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₽ ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₽ ' + value.toLocaleString();
              }
            },
            title: { display: true, text: 'Сумма (₽)' }
          },
          x: { 
            title: { display: true, text: 'Месяц' },
          }
        }
      }
    });
  });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      // Круговая диаграмма
      const labels = JSON.parse(document.getElementById('pieLabels').textContent);
      const data = JSON.parse(document.getElementById('pieData').textContent);

      if (labels.length === 0 || data.length === 0) {
        console.warn('Нет данных для круговой диаграммы');
        return;
      }

      const ctx = document.getElementById('pieChart').getContext('2d');
      const pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
              '#FF9F40', '#FFCD56', '#4D5360', '#FF6F61', '#6B4423'
            ],
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value.toLocaleString()} ₽ (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    });
  </script>

{% endif %}
{% endblock %}
{% extends 'base.html' %}
{% load extra_filters %}
{% load l10n %}

{% block title %}Главная{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
    <div class="alert alert-warning text-center">
        Пожалуйста, <a href="{% url 'login' %}">войдите</a> в систему, чтобы увидеть данные.
    </div>
{% else %}

<style>
    /* Основные стили для таблицы */
    #transactions-table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
        padding: 16px;
    }

    /* Увеличенные отступы для ячеек */
    #transactions-table th,
    #transactions-table td {
        padding: 12px;
        box-sizing: border-box;
    }

    /* Уменьшенная высота строк */
    #transactions-table tbody tr {
        height: 32px;
    }

    /* Стили для кнопок */
    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        min-width: 70px;
        padding: 4px 12px;
        white-space: nowrap;
        word-break: break-word;
    }

    /* Стили для ячеек с текстом */
    #transactions-table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Фиксированная ширина столбцов */
    #transactions-table th.date,
    #transactions-table td.date {
        width: 200px;
        padding-left: 16px;
        padding-right: 16px;
    }

    #transactions-table th.type,
    #transactions-table td.type {
        width: 80px;
        padding-left: 12px;
        padding-right: 12px;
    }

    #transactions-table th.amount,
    #transactions-table td.amount {
        width: 120px;
        padding-left: 12px;
        padding-right: 12px;
    }

    #transactions-table th.category,
    #transactions-table td.category {
        width: 180px;
        padding-left: 12px;
        padding-right: 12px;
    }

    #transactions-table th.description,
    #transactions-table td.description {
        width: 200px;
        padding-left: 12px;
        padding-right: 12px;
    }

    #transactions-table th.actions,
    #transactions-table td.actions {
        width: 200px;
        text-align: right;
        padding-right: 16px;
    }

    /* Стили для контейнера таблицы */
    .table-wrapper {
        overflow-x: auto;
        width: 100%;
        padding: 16px;
    }

    /* Стили для четных строк */
    #transactions-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    /* Уменьшенный размер шрифта для кнопок */
    .btn-sm {
        font-size: 0.7rem;
    }

    /* Дополнительные стили для улучшения читаемости */
    #transactions-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        padding: 12px;
    }
</style>

<div class="row mb-4 g-2">
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Доходы</h5>
                <p class="card-text fs-4">{{ total_income|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">Расходы</h5>
                <p class="card-text fs-4">{{ total_expense|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Баланс</h5>
                <p class="card-text fs-4">{{ total_income|subtract:total_expense|floatformat:2 }} ₽</p>
            </div>
        </div>
    </div>
</div>

<!-- Форма поиска и фильтров -->
<form method="get" class="mb-4">
    <div class="row g-3">
        <!-- Поиск по описанию -->
        <div class="col-md-3">
            <label for="search" class="form-label">Поиск по описанию</label>
            <input type="text"
                   class="form-control"
                   id="search"
                   name="q"
                   value="{{ search_query }}"
                   placeholder="Введите текст...">
        </div>

        <!-- Категория -->
        <div class="col-md-3">
            <label for="category" class="form-label">Категория</label>
            <select class="form-select" id="category" name="category">
                <option value="">Все категории</option>
                {% for category in categories %}
                <option value="{{ category.id }}"
                        {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Дата начала -->
        <div class="col-md-3">
            <label for="start_date" class="form-label">Начало периода</label>
            <input type="date"
                   class="form-control"
                   id="start_date"
                   name="start_date"
                   value="{% if start_date %}{{ start_date }}{% endif %}">
        </div>

        <!-- Дата окончания -->
        <div class="col-md-3">
            <label for="end_date" class="form-label">Конец периода</label>
            <input type="date"
                   class="form-control"
                   id="end_date"
                   name="end_date"
                   value="{% if end_date %}{{ end_date }}{% endif %}">
        </div>

        <!-- Кнопки -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Найти</button>
        </div>
        <div class="col-md-2">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary w-100">Сбросить</a>
        </div>
        <div class="col-md-2">
            <a href="{% url 'export_csv' %}?start_date={{ start_date }}&end_date={{ end_date }}&q={{ search_query }}&category={{ selected_category }}"
               class="btn btn-outline-primary w-100">Экспорт</a>
        </div>
    </div>
</form>

<!-- Таблица операций -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Последние операции</h5>
        <button id="show-all-btn"
                class="btn btn-outline-primary btn-sm"
                data-is-expanded="false"
                data-total-count="{{ total_transactions_count }}">
            Показать все ({{ total_transactions_count }})
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-wrapper" style="overflow-x: auto;">
            <table class="table table-hover" id="transactions-table">
                <thead>
                    <tr>
                        <th class="date" style="width: 120px;">Дата</th>
                        <th class="type" style="width: 80px;">Тип</th>
                        <th class="amount" style="width: 120px;">Сумма</th>
                        <th class="category" style="width: 180px;">Категория</th>
                        <th class="description" style="width: 300px;">Описание</th>
                        <th class="actions" style="width: 200px;">Действия</th>
                    </tr>
                </thead>
                <tbody id="transactions-tbody">
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td class="date">{{ transaction.date|date:"d.m.Y" }}</td>
                        <td class="type">
                            {% if transaction.transaction_type == 'income' %}
                                <span class="text-success">Доход</span>
                            {% else %}
                                <span class="text-danger">Расход</span>
                            {% endif %}
                        </td>
                        <td class="amount">{{ transaction.amount }} ₽</td>
                        <td class="category">{{ transaction.category.name|default:"—" }}</td>
                        <td class="description" title="{{ transaction.description }}">
                            {{ transaction.description|default:"—" }}
                        </td>
                        <td class="actions">
                            <div class="btn-group" role="group">
                                <a href="{% url 'edit_transaction' transaction.id %}"
                                   class="btn btn-sm btn-outline-primary">Редактировать</a>
                                <a href="{% url 'delete_transaction' transaction.id %}"
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Вы уверены, что хотите удалить эту операцию?')">Удалить</a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">Нет операций за выбранный период</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<template id="all-transactions-template">
    {% for transaction in all_transactions %}
    <tr>
        <td class="date">{{ transaction.date|date:"d.m.Y" }}</td>
        <td class="type">
            {% if transaction.transaction_type == 'income' %}
                <span class="text-success">Доход</span>
            {% else %}
                <span class="text-danger">Расход</span>
            {% endif %}
        </td>
        <td class="amount">{{ transaction.amount }} ₽</td>
        <td class="category">{{ transaction.category.name|default:"—" }}</td>
        <td class="description" title="{{ transaction.description }}">
            {{ transaction.description|default:"—" }}
        </td>
        <td class="actions">
            <div class="btn-group" role="group">
                <a href="{% url 'edit_transaction' transaction.id %}"
                   class="btn btn-sm btn-outline-primary">Редактировать</a>
                <a href="{% url 'delete_transaction' transaction.id %}"
                   class="btn btn-sm btn-outline-danger"
                   onclick="return confirm('Вы уверены, что хотите удалить эту операцию?')">Удалить</a>
            </div>
        </td>
    </tr>
    {% endfor %}
</template>

<!-- ПЕРЕДАЧА ДАННЫХ ДЛЯ ГРАФИКОВ -->
{{ labels_expense|json_script:"labelsExpense" }}
{{ data_expense|json_script:"dataExpense" }}
{{ labels_income|json_script:"labelsIncome" }}
{{ data_income|json_script:"dataIncome" }}


<!-- ПЕРЕДАЧА ДАННЫХ ДЛЯ КРУГОВОЙ ДИАГРАММЫ -->
{{ pie_labels|json_script:"pieLabels" }}
{{ pie_data|json_script:"pieData" }}

<!-- Графики -->
<div class="row mt-4">
    <!-- График расходов -->
    <div class="col-md-6">
        <h6 style="text-align: center; width: 100%;">Расходы по месяцам</h6>
        <canvas id="expenseChart" width="400" height="200"></canvas>
    </div>

    <!-- График доходов -->
    <div class="col-md-6">
        <h6 style="text-align: center; width: 100%;">Доходы по месяцам</h6>
        <canvas id="incomeChart" width="400" height="200"></canvas>
    </div>
</div>

<!-- Круговая диаграмма (распределение расходов по категориям) -->
<div class="container mt-5">
  <h4 class="text-center">Распределение расходов по категориям</h4>
  <div style="
    width: 350px;
    height: 350px;
    margin: 20px auto;
    display: flex;
    justify-content: center;
    align-items: center;
  ">
    <canvas id="pieChart"></canvas>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // График расходов
    const ctxExpense = document.getElementById('expenseChart').getContext('2d');
    const expenseChart = new Chart(ctxExpense, {
      type: 'bar',
      data: {
        labels: JSON.parse(document.getElementById('labelsExpense').textContent),
        datasets: [{
          label: 'Расходы (₽)',
          data: JSON.parse(document.getElementById('dataExpense').textContent),
          backgroundColor: 'rgba(220, 53, 69, 0.6)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₽ ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₽ ' + value.toLocaleString();
              }
            },
            title: { display: true, text: 'Сумма (₽)' }
          },
          x: { 
            title: { display: true, text: 'Месяц' },
          }
        }
      }
    });

    // График доходов
    const ctxIncome = document.getElementById('incomeChart').getContext('2d');
    const incomeChart = new Chart(ctxIncome, {
      type: 'bar',
      data: {
        labels: JSON.parse(document.getElementById('labelsIncome').textContent),
        datasets: [{
          label: 'Доходы (₽)',
          data: JSON.parse(document.getElementById('dataIncome').textContent),
          backgroundColor: 'rgba(40, 167, 69, 0.6)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₽ ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₽ ' + value.toLocaleString();
              }
            },
            title: { display: true, text: 'Сумма (₽)' }
          },
          x: { 
            title: { display: true, text: 'Месяц' },
          }
        }
      }
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Круговая диаграмма
    const labels = JSON.parse(document.getElementById('pieLabels').textContent);
    const data = JSON.parse(document.getElementById('pieData').textContent);

    if (labels.length === 0 || data.length === 0) {
      console.warn('Нет данных для круговой диаграммы');
      return;
    }

    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FFCD56', '#4D5360', '#FF6F61', '#6B4423'
          ],
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value.toLocaleString()} ₽ (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const showAllBtn = document.getElementById('show-all-btn');
    const tableBody = document.getElementById('transactions-tbody');
    const template = document.getElementById('all-transactions-template');

    showAllBtn.addEventListener('click', function() {
        const isExpanded = showAllBtn.getAttribute('data-is-expanded') === 'true';

        if (!isExpanded) {
            const scrollTop = tableBody.parentElement.scrollTop;

            tableBody.innerHTML = template.innerHTML;
            showAllBtn.textContent = 'Свернуть до 5 последних';
            showAllBtn.setAttribute('data-is-expanded', 'true');

            tableBody.parentElement.scrollTop = scrollTop;
        } else {
            const scrollTop = tableBody.parentElement.scrollTop;


            const initialRows = `
                {% for transaction in recent_transactions %}
                <tr>
                    <td class="date">{{ transaction.date|date:"d.m.Y" }}</td>
                    <td class="type">
                        {% if transaction.transaction_type == 'income' %}
                            <span class="text-success">Доход</span>
                        {% else %}
                            <span class="text-danger">Расход</span>
                        {% endif %}
                    </td>
                    <td class="amount">{{ transaction.amount }} ₽</td>
                    <td class="category">{{ transaction.category.name|default:"—" }}</td>
                    <td class="description" title="{{ transaction.description }}">
                        {{ transaction.description|default:"—" }}
                    </td>
                    <td class="actions">
                        <div class="btn-group" role="group">
                            <a href="{% url 'edit_transaction' transaction.id %}"
                               class="btn btn-sm btn-outline-primary">Редактировать</a>
                            <a href="{% url 'delete_transaction' transaction.id %}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Вы уверены, что хотите удалить эту операцию?')">Удалить</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            `;
            tableBody.innerHTML = initialRows;
            showAllBtn.textContent = `Показать все (${showAllBtn.getAttribute('data-total-count')})`;
            showAllBtn.setAttribute('data-is-expanded', 'false');


            tableBody.parentElement.scrollTop = scrollTop;
        }
    });
});
</script>

{% endif %}
{% endblock %}
